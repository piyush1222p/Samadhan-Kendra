<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Samadhan Kendra</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="admin-styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="admin-body">
    <!-- Admin Navigation -->
    <nav class="admin-navbar">
        <div class="admin-nav-container">
            <div class="admin-nav-logo">
                <a href="index.html">
                    <i class="fas fa-handshake"></i>
                    <span>Samadhan Kendra</span>
                </a>
                <span class="admin-badge">Admin Panel</span>
            </div>
            <div class="admin-nav-user">
                <div class="admin-user-info">
                    <i class="fas fa-user-shield"></i>
                    <span id="adminUserName">Administrator</span>
                </div>
                <div class="admin-user-avatar" onclick="toggleAdminProfileMenu()">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="admin-profile-dropdown" id="adminProfileDropdown">
                    <a href="#" onclick="showAdminProfile()"><i class="fas fa-user"></i> Profile</a>
                    <a href="#" onclick="showAdminSettings()"><i class="fas fa-cog"></i> Settings</a>
                    <a href="#" onclick="adminPanel.showLogoutConfirmation()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Admin Sidebar -->
    <div class="admin-sidebar" id="adminSidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h3>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li class="sidebar-item active" data-tab="dashboard">
                    <a href="#dashboard">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="sidebar-item" data-tab="users">
                    <a href="#users">
                        <i class="fas fa-users"></i>
                        <span>User Management</span>
                    </a>
                </li>
                <li class="sidebar-item" data-tab="issues">
                    <a href="#issues">
                        <i class="fas fa-flag"></i>
                        <span>Issue Management</span>
                    </a>
                </li>
                <li class="sidebar-item" data-tab="categories">
                    <a href="#categories">
                        <i class="fas fa-tags"></i>
                        <span>Categories & Settings</span>
                    </a>
                </li>
                <li class="sidebar-item" data-tab="audit">
                    <a href="#audit">
                        <i class="fas fa-history"></i>
                        <span>Audit Log</span>
                    </a>
                </li>
                <li class="sidebar-item" data-tab="profile">
                    <a href="#profile">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>
                </li>
                <li class="sidebar-item" data-tab="settings">
                    <a href="#settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Admin Main Content -->
    <main class="admin-main">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="admin-tab active">
            <div class="admin-header">
                <h1>Dashboard Overview</h1>
                <p>Monitor system statistics and recent activity</p>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalUsers">0</h3>
                        <p>Total Users</p>
                        <span class="stat-change positive">+12% this month</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-flag"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalIssues">0</h3>
                        <p>Total Issues</p>
                        <span class="stat-change positive">+8% this week</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="resolvedIssues">0</h3>
                        <p>Resolved Issues</p>
                        <span class="stat-change positive">+15% this month</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="pendingIssues">0</h3>
                        <p>Pending Issues</p>
                        <span class="stat-change negative">+5% this week</span>
                    </div>
                </div>
            </div>

            <!-- Charts and Analytics -->
            <div class="analytics-grid">
                <div class="chart-card">
                    <h3>Issue Departments Distribution</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Monthly Issue Trends</h3>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="recent-activity">
                <h3>Recent Activity</h3>
                <div class="activity-list" id="recentActivityList">
                    <!-- Activity items will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users" class="admin-tab">
            <div class="admin-header">
                <h1>User Management</h1>
                <p>Manage registered users and their accounts</p>
            </div>

            <!-- User Search and Filters -->
            <div class="user-controls">
                <div class="search-box">
                    <input type="text" id="userSearch" placeholder="Search users by name, email, or city...">
                    <i class="fas fa-search"></i>
                </div>
                <div class="user-filters">
                    <select id="userStatusFilter">
                        <option value="all">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="suspended">Suspended</option>
                    </select>
                    <select id="userRoleFilter">
                        <option value="all">All Roles</option>
                        <option value="user">Regular User</option>
                        <option value="moderator">Moderator</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="showAddUserModal()">
                    <i class="fas fa-user-plus"></i> Add New User
                </button>
            </div>

            <!-- Users Table -->
            <div class="table-container">
                <table class="admin-table" id="usersTable">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>City</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Points</th>
                            <th>Issues</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- User Statistics -->
            <div class="user-stats">
                <div class="stat-card">
                    <i class="fas fa-users"></i>
                    <div class="stat-info">
                        <h3 id="totalUsers">0</h3>
                        <p>Total Users</p>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-user-check"></i>
                    <div class="stat-info">
                        <h3 id="activeUsers">0</h3>
                        <p>Active Users</p>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-user-clock"></i>
                    <div class="stat-info">
                        <h3 id="newUsersThisMonth">0</h3>
                        <p>New This Month</p>
                    </div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-star"></i>
                    <div class="stat-info">
                        <h3 id="topContributors">0</h3>
                        <p>Top Contributors</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Issues Tab -->
        <div id="issues" class="admin-tab">
            <div class="admin-header">
                <h1>Issue Management</h1>
                <p>Monitor and manage reported civic issues</p>
            </div>

            <!-- Issue Controls -->
            <div class="issue-controls">
                <div class="search-box">
                    <input type="text" id="issueSearch" placeholder="Search issues by title, description, or address...">
                    <i class="fas fa-search"></i>
                </div>
                <div class="issue-filters">
                    <select id="issueStatusFilter">
                        <option value="all">All Statuses</option>
                        <option value="reported">Reported</option>
                        <option value="investigating">Investigating</option>
                        <option value="in-progress">In Progress</option>
                        <option value="resolved">Resolved</option>
                    </select>
                    <select id="issuePriorityFilter">
                        <option value="all">All Priorities</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                    <select id="issueCategoryFilter">
                        <option value="all">All Departments</option>
                    </select>
                </div>
            </div>

            <!-- Issues Table -->
            <div class="table-container">
                <table class="admin-table" id="issuesTable">
                    <thead>
                        <tr>
                            <th>Issue ID</th>
                            <th>Title</th>
                            <th>Department</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Reporter</th>
                            <th>Location</th>
                            <th>Reported</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="issuesTableBody">
                        <!-- Issues will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Categories Tab -->
        <div id="categories" class="admin-tab">
            <div class="admin-header">
                <h1>Categories & Settings</h1>
                <p>Manage issue categories and application settings</p>
            </div>

            <!-- Categories Management -->
            <div class="categories-section">
                <h3>Issue Categories</h3>
                <div class="categories-grid" id="categoriesGrid">
                    <!-- Categories will be populated by JavaScript -->
                </div>
                <button class="btn btn-primary" onclick="showAddCategoryModal()">
                    <i class="fas fa-plus"></i> Add New Category
                </button>
            </div>

            <!-- Application Settings -->
            <div class="settings-section">
                <h3>Application Settings</h3>
                <div class="settings-form">
                    <div class="setting-group">
                        <label>Email Notifications</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="emailNotifications" checked>
                            <span class="slider"></span>
                        </div>
                    </div>
                    <div class="setting-group">
                        <label>SMS Notifications</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="smsNotifications">
                            <span class="slider"></span>
                        </div>
                    </div>
                    <div class="setting-group">
                        <label>Auto-assign Issues</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="autoAssignIssues" checked>
                            <span class="slider"></span>
                        </div>
                    </div>
                    <div class="setting-group">
                        <label>Maintenance Mode</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="maintenanceMode">
                            <span class="slider"></span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Audit Tab -->
        <div id="audit" class="admin-tab">
            <div class="admin-header">
                <h1>Audit Log</h1>
                <p>Track all administrative actions and system changes</p>
            </div>

            <!-- Audit Filters -->
            <div class="audit-controls">
                <div class="search-box">
                    <input type="text" id="auditSearch" placeholder="Search audit logs...">
                    <i class="fas fa-search"></i>
                </div>
                <div class="audit-filters">
                    <select id="auditActionFilter">
                        <option value="all">All Actions</option>
                        <option value="create">Create</option>
                        <option value="update">Update</option>
                        <option value="delete">Delete</option>
                        <option value="status_change">Status Change</option>
                    </select>
                    <select id="auditUserFilter">
                        <option value="all">All Users</option>
                        <!-- Admin users will be populated -->
                    </select>
                    <input type="date" id="auditDateFilter">
                </div>
            </div>

            <!-- Audit Table -->
            <div class="table-container">
                <table class="admin-table" id="auditTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Admin User</th>
                            <th>Action</th>
                            <th>Resource</th>
                            <th>Details</th>
                            <th>IP Address</th>
                        </tr>
                    </thead>
                    <tbody id="auditTableBody">
                        <!-- Audit logs will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profile" class="admin-tab">
            <div class="admin-header">
                <h1>Admin Profile</h1>
                <p>Manage your admin account and personal information</p>
            </div>

            <div class="profile-grid">
                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div class="profile-info">
                            <h3 id="adminProfileName">Administrator</h3>
                            <p id="adminProfileEmail">admin@samadhankendra.com</p>
                            <span class="role-badge role-admin">Super Admin</span>
                        </div>
                    </div>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="stat-number">1,247</span>
                            <span class="stat-label">Issues Managed</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">89</span>
                            <span class="stat-label">Users Managed</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">156</span>
                            <span class="stat-label">Days Active</span>
                        </div>
                    </div>
                </div>

                <div class="profile-form-card">
                    <h3>Personal Information</h3>
                    <form id="adminProfileForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="adminFullName">Full Name</label>
                                <input type="text" id="adminFullName" value="Administrator" required>
                            </div>
                            <div class="form-group">
                                <label for="adminEmail">Email</label>
                                <input type="email" id="adminEmail" value="admin@samadhankendra.com" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="adminPhone">Phone</label>
                                <input type="tel" id="adminPhone" value="+91 98765 43210" required>
                            </div>
                            <div class="form-group">
                                <label for="adminDepartment">Department</label>
                                <input type="text" id="adminDepartment" value="IT Administration" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="adminBio">Bio</label>
                            <textarea id="adminBio" rows="3" placeholder="Tell us about yourself...">Experienced administrator with expertise in civic issue management and system administration.</textarea>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="adminPanel.updateProfile()">
                            <i class="fas fa-save"></i> Update Profile
                        </button>
                    </form>
                </div>

                <div class="profile-form-card">
                    <h3>Change Password</h3>
                    <form id="adminPasswordForm">
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password</label>
                            <input type="password" id="confirmPassword" required>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="adminPanel.changePassword()">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="admin-tab">
            <div class="admin-header">
                <h1>Admin Settings</h1>
                <p>Configure system settings and preferences</p>
            </div>

            <div class="settings-grid">
                <div class="settings-card">
                    <h3>Notification Settings</h3>
                    <div class="settings-form">
                        <div class="setting-group">
                            <label>Email Notifications</label>
                            <div class="toggle-switch">
                                <input type="checkbox" id="adminEmailNotifications" checked>
                                <span class="slider"></span>
                            </div>
                        </div>
                        <div class="setting-group">
                            <label>SMS Notifications</label>
                            <div class="toggle-switch">
                                <input type="checkbox" id="adminSmsNotifications">
                                <span class="slider"></span>
                            </div>
                        </div>
                        <div class="setting-group">
                            <label>Issue Alerts</label>
                            <div class="toggle-switch">
                                <input type="checkbox" id="adminIssueAlerts" checked>
                                <span class="slider"></span>
                            </div>
                        </div>
                        <div class="setting-group">
                            <label>User Activity Reports</label>
                            <div class="toggle-switch">
                                <input type="checkbox" id="adminUserReports">
                                <span class="slider"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>System Preferences</h3>
                    <div class="settings-form">
                        <div class="setting-group">
                            <label>Auto-refresh Dashboard</label>
                            <div class="toggle-switch">
                                <input type="checkbox" id="adminAutoRefresh" checked>
                                <span class="slider"></span>
                            </div>
                        </div>
                        <div class="setting-group">
                            <label>Dark Mode</label>
                            <div class="toggle-switch">
                                <input type="checkbox" id="adminDarkMode">
                                <span class="slider"></span>
                            </div>
                        </div>
                        <div class="setting-group">
                            <label>Compact View</label>
                            <div class="toggle-switch">
                                <input type="checkbox" id="adminCompactView">
                                <span class="slider"></span>
                            </div>
                        </div>
                        <div class="setting-group">
                            <label>Session Timeout Warning</label>
                            <div class="toggle-switch">
                                <input type="checkbox" id="adminSessionWarning" checked>
                                <span class="slider"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>Data Management</h3>
                    <div class="settings-actions">
                        <button class="btn btn-export" onclick="adminPanel.exportData()">
                            <i class="fas fa-download"></i> Export Data
                        </button>
                        <button class="btn btn-backup" onclick="adminPanel.backupSystem()">
                            <i class="fas fa-database"></i> Backup System
                        </button>
                        <button class="btn btn-danger" onclick="adminPanel.clearCache()">
                            <i class="fas fa-broom"></i> Clear Cache
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add User Modal -->
    <div id="addUserModal" class="admin-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New User</h3>
                <span class="close" onclick="closeModal('addUserModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newUserName">Full Name</label>
                            <input type="text" id="newUserName" required>
                        </div>
                        <div class="form-group">
                            <label for="newUserEmail">Email</label>
                            <input type="email" id="newUserEmail" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newUserPhone">Phone</label>
                            <input type="tel" id="newUserPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="newUserCity">City</label>
                            <select id="newUserCity" required>
                                <option value="">Select city</option>
                                <option value="mumbai">Mumbai</option>
                                <option value="delhi">Delhi</option>
                                <option value="bangalore">Bangalore</option>
                                <option value="hyderabad">Hyderabad</option>
                                <option value="chennai">Chennai</option>
                                <option value="kolkata">Kolkata</option>
                                <option value="pune">Pune</option>
                                <option value="ahmedabad">Ahmedabad</option>
                                <option value="jaipur">Jaipur</option>
                                <option value="lucknow">Lucknow</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newUserRole">Role</label>
                            <select id="newUserRole" required>
                                <option value="user">Regular User</option>
                                <option value="moderator">Moderator</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newUserPassword">Password</label>
                            <input type="password" id="newUserPassword" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addUserModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addNewUser()">Add User</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="admin-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit User</h3>
                <span class="close" onclick="closeModal('editUserModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUserName">Full Name</label>
                            <input type="text" id="editUserName" required>
                        </div>
                        <div class="form-group">
                            <label for="editUserEmail">Email</label>
                            <input type="email" id="editUserEmail" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUserPhone">Phone</label>
                            <input type="tel" id="editUserPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="editUserCity">City</label>
                            <select id="editUserCity" required>
                                <option value="">Select city</option>
                                <option value="mumbai">Mumbai</option>
                                <option value="delhi">Delhi</option>
                                <option value="bangalore">Bangalore</option>
                                <option value="hyderabad">Hyderabad</option>
                                <option value="chennai">Chennai</option>
                                <option value="kolkata">Kolkata</option>
                                <option value="pune">Pune</option>
                                <option value="ahmedabad">Ahmedabad</option>
                                <option value="jaipur">Jaipur</option>
                                <option value="lucknow">Lucknow</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUserRole">Role</label>
                            <select id="editUserRole" required>
                                <option value="user">Regular User</option>
                                <option value="moderator">Moderator</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editUserStatus">Status</label>
                            <select id="editUserStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUserPoints">Points</label>
                            <input type="number" id="editUserPoints" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="editUserPassword">New Password (leave blank to keep current)</label>
                            <input type="password" id="editUserPassword" placeholder="Enter new password if changing">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editUserModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveUserChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="userDetailsModal" class="admin-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>User Details</h3>
                <span class="close" onclick="closeModal('userDetailsModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="userDetailsContent">
                    <!-- User details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('userDetailsModal')">Close</button>
                <button class="btn btn-primary" onclick="editUserFromDetails()">Edit User</button>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="admin-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Category</h3>
                <span class="close" onclick="closeModal('addCategoryModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="form-group">
                        <label for="newCategoryName">Category Name</label>
                        <input type="text" id="newCategoryName" placeholder="e.g., Street Lighting" required>
                    </div>
                    <div class="form-group">
                        <label for="newCategoryIcon">Icon (Emoji)</label>
                        <input type="text" id="newCategoryIcon" placeholder="💡" required>
                    </div>
                    <div class="form-group">
                        <label for="newCategoryDescription">Description</label>
                        <textarea id="newCategoryDescription" rows="3" placeholder="Brief description of this category"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newCategoryPriority">Default Priority</label>
                        <select id="newCategoryPriority" required>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addCategoryModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addNewCategory()">Add Category</button>
            </div>
        </div>
    </div>

    <!-- Edit Issue Modal -->
    <div id="editIssueModal" class="admin-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Issue</h3>
                <span class="close" onclick="closeModal('editIssueModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editIssueForm">
                    <input type="hidden" id="editIssueId">
                    <div class="issue-status-section">
                        <h4>Issue Status Management</h4>
                        <div class="status-timeline">
                            <div class="status-step" data-status="reported">
                                <div class="status-icon">
                                    <i class="fas fa-flag"></i>
                                </div>
                                <div class="status-info">
                                    <span class="status-label">Reported</span>
                                    <span class="status-date">Issue submitted by user</span>
                                </div>
                            </div>
                            <div class="status-step" data-status="investigating">
                                <div class="status-icon">
                                    <i class="fas fa-search"></i>
                                </div>
                                <div class="status-info">
                                    <span class="status-label">Investigating</span>
                                    <span class="status-date">Under review by authorities</span>
                                </div>
                            </div>
                            <div class="status-step" data-status="in-progress">
                                <div class="status-icon">
                                    <i class="fas fa-tools"></i>
                                </div>
                                <div class="status-info">
                                    <span class="status-label">In Progress</span>
                                    <span class="status-date">Work has begun</span>
                                </div>
                            </div>
                            <div class="status-step" data-status="resolved">
                                <div class="status-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="status-info">
                                    <span class="status-label">Resolved</span>
                                    <span class="status-date">Issue has been fixed</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editIssueTitle">Issue Title</label>
                            <input type="text" id="editIssueTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="editIssueStatus">Current Status</label>
                            <select id="editIssueStatus" required onchange="adminPanel.updateStatusTimeline(this.value)">
                                <option value="reported">Reported</option>
                                <option value="investigating">Investigating</option>
                                <option value="in-progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editIssueDepartment">Department</label>
                            <select id="editIssueDepartment" required>
                                <!-- Departments will be populated -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editIssuePriority">Priority Level</label>
                            <select id="editIssuePriority" required>
                                <option value="low">Low Priority</option>
                                <option value="medium">Medium Priority</option>
                                <option value="high">High Priority</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editIssueDescription">Issue Description</label>
                        <textarea id="editIssueDescription" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editIssueNotes">Admin Notes & Updates</label>
                        <textarea id="editIssueNotes" rows="3" placeholder="Add internal notes, progress updates, or instructions for the team..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editIssueAssigneeUserId">Assign To (User ID)</label>
                        <input type="number" id="editIssueAssigneeUserId" min="1" placeholder="Enter staff user ID (optional)">
                        <small class="muted">Only staff users can be assigned. Leave blank to keep current assignee.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeModal('editIssueModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveIssueChanges()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Success/Error Toast -->
    <div id="toast" class="toast">
        <div class="toast-content">
            <i class="toast-icon"></i>
            <span class="toast-message"></span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="admin-script.js"></script>

    <!-- App config (API base) -->
    <script src="./config.js"></script>

    <!-- Backend wiring for Admin Panel -->
    <script type="module">
        import { getGrievances, getDepartments, setStatus, assign, logout as apiLogout } from "./js/api.js";

        // ----------------- Helpers -----------------
        const API_BASE = window.CONFIG?.API_BASE ?? "http://localhost:8000/api";
        const issuesTBody = document.getElementById("issuesTableBody");
        const issueSearchEl = document.getElementById("issueSearch");
        const statusFilterEl = document.getElementById("issueStatusFilter");
        const priorityFilterEl = document.getElementById("issuePriorityFilter");
        const deptFilterEl = document.getElementById("issueCategoryFilter");

        const editForm = document.getElementById("editIssueForm");
        const editIdEl = document.getElementById("editIssueId");
        const editTitleEl = document.getElementById("editIssueTitle");
        const editStatusEl = document.getElementById("editIssueStatus");
        const editDeptEl = document.getElementById("editIssueDepartment");
        const editPriorityEl = document.getElementById("editIssuePriority");
        const editDescEl = document.getElementById("editIssueDescription");
        const editNotesEl = document.getElementById("editIssueNotes");
        const editAssigneeIdEl = document.getElementById("editIssueAssigneeUserId");

        const PRIORITY_TO_NUM = { low: 1, medium: 2, high: 3, urgent: 4 };
        const NUM_TO_PRIORITY = { 1: "low", 2: "medium", 3: "high", 4: "urgent" };

        let allDepartments = [];
        let grievancesCache = [];

        function toast(msg, type = "success") {
            const t = document.getElementById("toast");
            if (!t) return alert(msg);
            const icon = t.querySelector(".toast-icon");
            const text = t.querySelector(".toast-message");
            text.textContent = msg;
            t.className = `toast show ${type}`;
            if (icon) {
                icon.className = `toast-icon ${type === "error" ? "fas fa-times-circle" : "fas fa-check-circle"}`;
            }
            setTimeout(() => t.className = "toast", 2200);
        }

        function authHeaders() {
            const token = localStorage.getItem("accessToken");
            return {
                "Content-Type": "application/json",
                ...(token ? { "Authorization": `Bearer ${token}` } : {})
            };
        }

        async function patchGrievance(id, payload) {
            const res = await fetch(`${API_BASE}/grievances/${id}/`, {
                method: "PATCH",
                headers: authHeaders(),
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                let err = {};
                try { err = await res.json(); } catch {}
                throw err;
            }
            return res.json();
        }

        function ensureLoggedInAdmin() {
            const token = localStorage.getItem("accessToken");
            if (!token) {
                toast("Please login as admin", "error");
                setTimeout(() => window.location.href = "admin-login.html", 600);
                return false;
            }
            return true;
        }

        // ----------------- Departments -----------------
        async function loadDepartments() {
            try {
                allDepartments = await getDepartments();
                // Populate edit modal select
                if (editDeptEl) {
                    editDeptEl.innerHTML = `<option value="">Select department</option>` +
                        allDepartments.map(d => `<option value="${d.id}">${d.name}</option>`).join("");
                }
                // Populate filter
                if (deptFilterEl) {
                    deptFilterEl.innerHTML = `<option value="all">All Departments</option>` +
                        allDepartments.map(d => `<option value="${d.name}">${d.name}</option>`).join("");
                }
            } catch (e) {
                console.error("Failed to load departments", e);
            }
        }

        function deptNameById(id) {
            const d = allDepartments.find(x => String(x.id) === String(id));
            return d?.name ?? id ?? "";
        }

        // ----------------- Issues list -----------------
        function renderIssues(list) {
            if (!issuesTBody) return;
            if (!Array.isArray(list)) list = [];
            issuesTBody.innerHTML = list.map(g => {
                const priorityKey = NUM_TO_PRIORITY[g.priority] ?? g.priority ?? "medium";
                const deptName = g.department_name ?? deptNameById(g.department);
                const reporter = g.citizen_username ?? g.user?.username ?? "";
                const created = g.created_at ? new Date(g.created_at).toLocaleString() : "";
                const loc = g.address ?? (g.description?.match(/Address:\s*(.*)/)?.[1] ?? "");

                return `
                    <tr data-id="${g.id}">
                        <td>${g.id}</td>
                        <td>${escapeHtml(g.title || "")}</td>
                        <td>${escapeHtml(deptName || "")}</td>
                        <td class="priority-${escapeHtml(priorityKey)}">${escapeHtml(priorityKey.toUpperCase())}</td>
                        <td>${escapeHtml(String(g.status || "").replaceAll("_"," "))}</td>
                        <td>${escapeHtml(reporter)}</td>
                        <td>${escapeHtml(loc)}</td>
                        <td>${escapeHtml(created)}</td>
                        <td>
                            <button class="btn btn-xs" data-action="edit"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-xs" data-action="investigating">Investigating</button>
                            <button class="btn btn-xs" data-action="in-progress">In Progress</button>
                            <button class="btn btn-xs" data-action="resolved">Resolve</button>
                        </td>
                    </tr>
                `;
            }).join("");
        }

        function escapeHtml(str) {
            return String(str ?? "")
                .replaceAll("&","&amp;").replaceAll("<","&lt;")
                .replaceAll(">","&gt;").replaceAll('"',"&quot;")
                .replaceAll("'","&#039;");
        }

        function applyIssueFilters() {
            let list = grievancesCache.slice();
            const q = (issueSearchEl?.value || "").toLowerCase().trim();
            const status = statusFilterEl?.value || "all";
            const priority = priorityFilterEl?.value || "all";
            const dept = deptFilterEl?.value || "all";

            if (q) {
                list = list.filter(g => {
                    const hay = `${g.title||""} ${g.description||""} ${g.address||""}`.toLowerCase();
                    return hay.includes(q);
                });
            }
            if (status !== "all") {
                list = list.filter(g => String(g.status || "").toLowerCase() === status);
            }
            if (priority !== "all") {
                const want = priority.toLowerCase();
                list = list.filter(g => (NUM_TO_PRIORITY[g.priority] ?? String(g.priority)).toLowerCase() === want);
            }
            if (dept !== "all") {
                list = list.filter(g => {
                    const name = (g.department_name ?? deptNameById(g.department) ?? "").toLowerCase();
                    return name === dept.toLowerCase();
                });
            }
            renderIssues(list);
        }

        async function loadIssues() {
            try {
                const data = await getGrievances();
                grievancesCache = Array.isArray(data) ? data : [];
                // Dashboard stats quick fill
                const totalIssuesEl = document.querySelector("#dashboard #totalIssues");
                const resolvedIssuesEl = document.querySelector("#dashboard #resolvedIssues");
                const pendingIssuesEl = document.querySelector("#dashboard #pendingIssues");
                if (totalIssuesEl) totalIssuesEl.textContent = grievancesCache.length;
                if (resolvedIssuesEl) resolvedIssuesEl.textContent = grievancesCache.filter(g => g.status === "resolved").length;
                if (pendingIssuesEl) pendingIssuesEl.textContent = grievancesCache.filter(g => g.status !== "resolved").length;

                applyIssueFilters();
            } catch (e) {
                console.error("Failed to load grievances", e);
                toast("Failed to load issues", "error");
                renderIssues([]);
            }
        }

        // Row actions
        issuesTBody?.addEventListener("click", async (e) => {
            const btn = e.target.closest("button");
            if (!btn) return;
            const tr = e.target.closest("tr");
            const id = tr?.getAttribute("data-id");
            if (!id) return;

            const action = btn.getAttribute("data-action");
            const issue = grievancesCache.find(g => String(g.id) === String(id));
            if (!issue) return;

            if (action === "edit") {
                openEditModal(issue);
                return;
            }
            if (["investigating","in-progress","resolved"].includes(action)) {
                try {
                    await setStatus(id, action);
                    toast(`Status set to ${action}`);
                    await loadIssues();
                } catch (err) {
                    const detail = err?.detail || "Failed to change status";
                    toast(detail, "error");
                }
            }
        });

        // ----------------- Edit Modal -----------------
        function openEditModal(issue) {
            editIdEl.value = issue.id;
            editTitleEl.value = issue.title || "";
            editStatusEl.value = issue.status || "reported";
            const deptId = issue.department ?? allDepartments.find(d => d.name === issue.department_name)?.id ?? "";
            editDeptEl.value = deptId || "";
            editPriorityEl.value = (NUM_TO_PRIORITY[issue.priority] ?? "medium");
            editDescEl.value = issue.description || "";
            editNotesEl.value = "";
            editAssigneeIdEl.value = issue.assignee_id ?? "";

            adminPanel.updateStatusTimeline(editStatusEl.value);

            const modal = document.getElementById("editIssueModal");
            if (modal) modal.style.display = "block";
        }

        window.saveIssueChanges = async function saveIssueChanges() {
            const id = editIdEl.value;
            if (!id) return;

            const payload = {
                title: editTitleEl.value.trim(),
                description: editDescEl.value.trim(),
                priority: PRIORITY_TO_NUM[editPriorityEl.value] ?? 2,
                department: Number(editDeptEl.value) || null
            };

            try {
                if (!payload.title || !payload.description || !payload.department) {
                    toast("Please fill title, description and department", "error");
                    return;
                }
                // Basic field updates
                await patchGrievance(id, payload);

                // Status update (admin-only action)
                const desiredStatus = editStatusEl.value;
                const issue = grievancesCache.find(g => String(g.id) === String(id));
                if (issue && desiredStatus && desiredStatus !== issue.status) {
                    await setStatus(id, desiredStatus);
                }

                // Optional assign
                const assigneeId = Number(editAssigneeIdEl.value);
                if (assigneeId) {
                    await assign(id, assigneeId);
                }

                toast("Issue updated");
                closeModal("editIssueModal");
                await loadIssues();
            } catch (err) {
                console.error(err);
                const msg = err?.detail || "Update failed";
                toast(msg, "error");
            }
        };

        // Close any modal
        window.closeModal = function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.style.display = "none";
        };

        // ----------------- Admin Panel fallbacks -----------------
        window.adminPanel = window.adminPanel || {};
        if (!window.adminPanel.updateStatusTimeline) {
            window.adminPanel.updateStatusTimeline = function updateStatusTimeline(current) {
                document.querySelectorAll("#editIssueModal .status-step").forEach(step => {
                    step.classList.remove("active");
                    if (step.getAttribute("data-status") === current) {
                        step.classList.add("active");
                    }
                });
            };
        }
        if (!window.adminPanel.showLogoutConfirmation) {
            window.adminPanel.showLogoutConfirmation = function showLogoutConfirmation() {
                if (confirm("Logout from Admin?")) {
                    try { apiLogout(); } catch {}
                    localStorage.removeItem("userLoggedIn");
                    window.location.href = "admin-login.html";
                }
            };
        }
        // Optional stub methods to avoid console errors if admin-script.js doesn't define them
        window.showAdminProfile = window.showAdminProfile || function(){};
        window.showAdminSettings = window.showAdminSettings || function(){};
        window.addNewUser = window.addNewUser || function(){ toast("User creation not wired to backend yet", "error"); };
        window.saveUserChanges = window.saveUserChanges || function(){ toast("User update not wired to backend yet", "error"); };
        window.editUserFromDetails = window.editUserFromDetails || function(){};

        // Filters
        issueSearchEl?.addEventListener("input", applyIssueFilters);
        statusFilterEl?.addEventListener("change", applyIssueFilters);
        priorityFilterEl?.addEventListener("change", applyIssueFilters);
        deptFilterEl?.addEventListener("change", applyIssueFilters);

        // ----------------- Boot -----------------
        (async function boot() {
            if (!ensureLoggedInAdmin()) return;
            await loadDepartments();
            await loadIssues();
        })();
    </script>
    
    <!-- Chatbot Integration -->
    <script src="https://cdn.botpress.cloud/webchat/v3.2/inject.js"></script>
    <script src="https://files.bpcontent.cloud/2025/08/31/14/20250831144221-5HKMW4DF.js" defer></script>
</body>
</html>