<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Issue - Samadhan Kendra</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
    <style>
        /* Inline helpers */
        .notification {
            margin: 1rem 0 0;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            display: none;
        }
        .notification.success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .notification.error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .status-badge { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 999px; font-weight: 600; font-size: 0.8rem; }
        .status-badge.investigating { background: #fee2e2; color: #991b1b; }
        .status-badge.in-progress { background: #fef9c3; color: #854d0e; }
        .status-badge.resolved { background: #dcfce7; color: #166534; }
        .video-placeholder {
            display: grid; place-items: center; gap: .35rem; border: 1px dashed #cbd5e1; border-radius: 8px; padding: 2.5rem 1rem; color: #475569; cursor: pointer;
        }
        .video-placeholder i { font-size: 1.5rem; color: #0ea5e9; }
        .media-item img { width: 100%; height: auto; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="./index.html">
                    <i class="fas fa-handshake"></i>
                    <span>Samadhan Kendra</span>
                </a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="index.html#report" class="nav-link">Report Issue</a></li>
                <li><a href="index.html#issues" class="nav-link">View Issues</a></li>
                <li><a href="index.html#leaderboard" class="nav-link">Leaderboard</a></li>
                <li><a href="index.html#about" class="nav-link">About</a></li>
            </ul>
            <div class="nav-user">
                <div class="user-points">
                    <i class="fas fa-star"></i>
                    <span id="navUserPoints">0</span>
                </div>
                <div class="user-avatar" onclick="toggleProfileMenu()">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="profile-dropdown" id="profileDropdown">
                    <a href="#" onclick="handleProfileAccess()"><i class="fas fa-user"></i> Profile</a>
                    <a href="rewards-program.html"><i class="fas fa-gift"></i> Rewards</a>
                    <a href="login.html"><i class="fas fa-sign-in-alt"></i> Login</a>
                    <a href="register.html"><i class="fas fa-user-plus"></i> Register</a>
                    <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
            <div class="hamburger" aria-label="Toggle menu" aria-expanded="false" role="button" tabindex="0">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Issue Tracking Section -->
    <section class="track-issue-section">
        <div class="container">
            <div class="track-header">
                <a href="index.html#issues" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    Back to Issues
                </a>
                <h1>Issue Tracking</h1>
                <p>Monitor the progress of your reported civic issue</p>
                <div class="notification" id="pageNotice"></div>
            </div>

            <div class="issue-details-card">
                <div class="issue-header">
                    <div class="issue-title-section">
                        <h1 id="issueTitle">Large pothole on Andheri West Road</h1>
                        <div class="issue-meta">
                            <span class="issue-category" id="issueCategory">ðŸš§ Road &amp; Infrastructure</span>
                            <span class="issue-priority" id="issuePriority">High Priority</span>
                            <span class="issue-status" id="issueStatus">Investigating</span>
                        </div>
                    </div>
                    <div class="issue-actions">
                        <button class="btn btn-secondary" id="shareBtn">
                            <i class="fas fa-share"></i>
                            Share
                        </button>
                        <button class="btn btn-primary" id="upvoteBtn">
                            <i class="fas fa-thumbs-up"></i>
                            <span id="upvoteCount">12</span> Upvotes
                        </button>
                    </div>
                </div>

                <div class="issue-description">
                    <h3>Description</h3>
                    <p id="issueDescription">There is a significant pothole on Andheri West Road near the Metro station. It's causing damage to vehicles and is a safety hazard for motorists.</p>
                </div>

                <div class="issue-location">
                    <h3>Location Details</h3>
                    <div class="location-info">
                        <div class="location-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="issueAddress">Andheri West Road, Near Metro Station</span>
                        </div>
                        <div class="location-item">
                            <i class="fas fa-city"></i>
                            <span id="issueCity">Mumbai, Maharashtra</span>
                        </div>
                        <div class="location-item">
                            <i class="fas fa-crosshairs"></i>
                            <span id="issueGPS">19.1197, 72.8464</span>
                        </div>
                    </div>
                </div>

                <div class="issue-media">
                    <h3>Media Evidence</h3>
                    <div class="media-gallery" id="mediaGallery"></div>
                </div>
            </div>

            <!-- Progress Timeline -->
            <div class="progress-section">
                <h2>Progress Timeline</h2>
                <div class="timeline" id="progressTimeline"></div>
            </div>

            <!-- Status Updates -->
            <div class="status-updates-section">
                <h2>Status Updates</h2>
                <div class="status-updates" id="statusUpdates"></div>
            </div>

            <!-- Department Assignment -->
            <div class="department-section">
                <h2>Assigned Department</h2>
                <div class="department-card">
                    <div class="department-info">
                        <h3 id="deptName">Mumbai Municipal Corporation</h3>
                        <p id="deptTeam">Roads &amp; Infrastructure Department</p>
                        <div class="contact-info">
                            <span><i class="fas fa-phone"></i> <span id="deptPhone">+91 22 2262 1234</span></span>
                            <span><i class="fas fa-envelope"></i> <span id="deptEmail">roads@mcgm.gov.in</span></span>
                        </div>
                    </div>
                    <div class="department-status">
                        <span class="status-badge investigating" id="deptStatusBadge">Investigating</span>
                        <p id="deptStatusText">Issue under review by department officials</p>
                    </div>
                </div>
            </div>

            <!-- Estimated Resolution -->
            <div class="resolution-section">
                <h2>Estimated Resolution</h2>
                <div class="resolution-card">
                    <div class="resolution-info" id="resolutionInfo">
                        <div class="resolution-item">
                            <i class="fas fa-calendar-alt"></i>
                            <div>
                                <h4>Estimated Start Date</h4>
                                <p id="resStart">December 20, 2024</p>
                            </div>
                        </div>
                        <div class="resolution-item">
                            <i class="fas fa-clock"></i>
                            <div>
                                <h4>Estimated Duration</h4>
                                <p id="resDuration">3-5 working days</p>
                            </div>
                        </div>
                        <div class="resolution-item">
                            <i class="fas fa-tools"></i>
                            <div>
                                <h4>Work Type</h4>
                                <p id="resType">Road repair and resurfacing</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Related Issues -->
            <div class="related-issues-section">
                <h2>Related Issues Nearby</h2>
                <div class="related-issues" id="relatedIssues"></div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Samadhan Kendra</h3>
                    <p>Empowering Indian citizens through AI-driven civic engagement and smart city solutions.</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="index.html#report">Report Issue</a></li>
                        <li><a href="index.html#issues">View Issues</a></li>
                        <li><a href="index.html#leaderboard">Leaderboard</a></li>
                        <li><a href="index.html#about">About</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Support</h4>
                    <ul>
                        <li><a href="help-center.html">Help Center</a></li>
                        <li><a href="contact.html">Contact Us</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="terms-of-service.html">Terms of Service</a></li>
                        <li><a href="rewards-program.html">Rewards Program</a></li>
                    </ul>
                </div>
                <div class="footer-section"></div>
            </div>
            <div class="footer-bottom">
                <p>Â© 2025 Samadhan Kendra. Empowering India's Smart Cities.</p>
            </div>
        </div>
    </footer>

    <!-- App config and shared main -->
    <script src="./config.js"></script>
    <script type="module" src="./js/main.js"></script>

    <script>
        // Demo/default issue (fallback)
        const defaultIssue = {
            id: 'SK-2024-001',
            title: 'Large pothole on Andheri West Road',
            category: 'ðŸš§ Road & Infrastructure',
            priority: 'High Priority',
            status: 'Investigating',
            description: 'There is a significant pothole on Andheri West Road near the Metro station. It\'s causing damage to vehicles and is a safety hazard for motorists.',
            address: 'Andheri West Road, Near Metro Station',
            city: 'Mumbai, Maharashtra',
            gps: '19.1197, 72.8464',
            upvotes: 12,
            media: [
                { type: 'image', url: 'https://via.placeholder.com/800x500/ff6b6b/ffffff?text=Pothole+Image+1', alt: 'Pothole Image 1' },
                { type: 'image', url: 'https://via.placeholder.com/800x500/4ecdc4/ffffff?text=Pothole+Image+2', alt: 'Pothole Image 2' },
                { type: 'video', url: 'https://via.placeholder.com/800x500/45b7d1/ffffff?text=Video+Evidence', alt: 'Video Evidence' }
            ],
            progress: [
                { date: '2024-12-15', status: 'Reported', description: 'Issue reported by citizen', icon: 'fas fa-flag' },
                { date: '2024-12-16', status: 'Under Review', description: 'Issue reviewed by municipal staff', icon: 'fas fa-eye' },
                { date: '2024-12-17', status: 'Investigating', description: 'Department officials investigating the issue', icon: 'fas fa-search' }
            ],
            updates: [
                { date: '2024-12-17', update: 'Department officials have visited the site and assessed the damage. Work order is being prepared.', author: 'Mumbai Municipal Corporation' },
                { date: '2024-12-16', update: 'Issue has been assigned to Roads & Infrastructure Department for investigation.', author: 'Samadhan Kendra' },
                { date: '2024-12-15', update: 'Your issue has been successfully reported and is under review.', author: 'Samadhan Kendra' }
            ],
            related: [
                { id: 'SK-2024-002', title: 'Street light not working', category: 'âš¡ Electricity', status: 'In Progress', distance: '0.2 km' },
                { id: 'SK-2024-003', title: 'Garbage accumulation', category: 'ðŸ—‘ï¸ Garbage & Waste', status: 'Resolved', distance: '0.5 km' }
            ],
            department: {
                name: 'Mumbai Municipal Corporation',
                team: 'Roads & Infrastructure Department',
                phone: '+91 22 2262 1234',
                email: 'roads@mcgm.gov.in',
                status: 'Investigating',
                note: 'Issue under review by department officials'
            },
            resolution: {
                start: '2024-12-20',
                duration: '3-5 working days',
                type: 'Road repair and resurfacing'
            }
        };

        // Utilities
        function qs(param) {
            const url = new URL(window.location.href);
            return url.searchParams.get(param);
        }
        function setNotice(msg, type = 'success') {
            const n = document.getElementById('pageNotice');
            if (!n) return;
            n.textContent = msg;
            n.className = `notification ${type}`;
            n.style.display = 'block';
            setTimeout(() => { n.style.display = 'none'; }, 4200);
        }
        function isLoggedIn() {
            return !!localStorage.getItem('accessToken') || localStorage.getItem('userLoggedIn') === 'true';
        }
        function normalizeStatusClass(s) {
            return (s || '').toLowerCase().replace(/\s+/g, '-');
        }

        // Resolve issue: from URL (?id=), or localStorage 'issues', or default
        function resolveIssue() {
            const wantedId = qs('id');
            if (!wantedId) return defaultIssue;
            try {
                const localIssues = JSON.parse(localStorage.getItem('issues') || '[]');
                const found = localIssues.find(i => (i.id || i.issueId) === wantedId);
                if (found) return mapLegacyIssue(found);
            } catch {}
            // Could fetch from backend here if API exists
            return defaultIssue;
        }

        // Map a possible stored issue shape to our display shape (best-effort)
        function mapLegacyIssue(i) {
            return {
                id: i.id || i.issueId || defaultIssue.id,
                title: i.title || defaultIssue.title,
                category: i.category || defaultIssue.category,
                priority: i.priority || defaultIssue.priority,
                status: i.status || defaultIssue.status,
                description: i.description || defaultIssue.description,
                address: i.address || defaultIssue.address,
                city: i.city || defaultIssue.city,
                gps: i.gps || defaultIssue.gps,
                upvotes: Number(i.upvotes || i.votes || defaultIssue.upvotes),
                media: Array.isArray(i.media) && i.media.length ? i.media : defaultIssue.media,
                progress: Array.isArray(i.progress) && i.progress.length ? i.progress : defaultIssue.progress,
                updates: Array.isArray(i.updates) && i.updates.length ? i.updates : defaultIssue.updates,
                related: Array.isArray(i.related) && i.related.length ? i.related : defaultIssue.related,
                department: i.department || defaultIssue.department,
                resolution: i.resolution || defaultIssue.resolution
            };
        }

        // Renderers
        function renderIssue(issue) {
            document.getElementById('issueTitle').textContent = issue.title;
            document.getElementById('issueCategory').textContent = issue.category;
            document.getElementById('issuePriority').textContent = issue.priority;
            document.getElementById('issueStatus').textContent = issue.status;
            document.getElementById('issueDescription').textContent = issue.description;
            document.getElementById('issueAddress').textContent = issue.address;
            document.getElementById('issueCity').textContent = issue.city;
            document.getElementById('issueGPS').textContent = issue.gps;
            document.getElementById('upvoteCount').textContent = Number(issue.upvotes || 0);

            // Department
            if (issue.department) {
                document.getElementById('deptName').textContent = issue.department.name || '';
                document.getElementById('deptTeam').textContent = issue.department.team || '';
                document.getElementById('deptPhone').textContent = issue.department.phone || '';
                document.getElementById('deptEmail').textContent = issue.department.email || '';
                const badge = document.getElementById('deptStatusBadge');
                const text = document.getElementById('deptStatusText');
                if (badge) {
                    const cls = normalizeStatusClass(issue.department.status || 'Investigating');
                    badge.className = `status-badge ${cls}`;
                    badge.textContent = issue.department.status || 'Investigating';
                }
                if (text) text.textContent = issue.department.note || '';
            }

            // Resolution
            if (issue.resolution) {
                document.getElementById('resStart').textContent = new Date(issue.resolution.start || '').toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' }) || 'â€”';
                document.getElementById('resDuration').textContent = issue.resolution.duration || 'â€”';
                document.getElementById('resType').textContent = issue.resolution.type || 'â€”';
            }

            renderMedia(issue.media || []);
            renderProgress(issue.progress || []);
            renderUpdates(issue.updates || []);
            renderRelated(issue.related || []);
        }

        function renderMedia(items) {
            const gallery = document.getElementById('mediaGallery');
            gallery.innerHTML = '';
            items.forEach(media => {
                const wrap = document.createElement('div');
                wrap.className = 'media-item';
                if (media.type === 'image') {
                    wrap.innerHTML = `<img src="${media.url}" alt="${media.alt || 'Issue image'}" loading="lazy">`;
                    wrap.addEventListener('click', () => window.open(media.url, '_blank'));
                } else if (media.type === 'video') {
                    wrap.innerHTML = `
                        <div class="video-placeholder">
                            <i class="fas fa-play"></i>
                            <span>${media.alt || 'Video Evidence'}</span>
                        </div>
                    `;
                    wrap.addEventListener('click', () => window.open(media.url, '_blank'));
                }
                gallery.appendChild(wrap);
            });
        }

        function renderProgress(steps) {
            const timeline = document.getElementById('progressTimeline');
            timeline.innerHTML = '';
            // sort ascending by date
            const sorted = [...steps].sort((a, b) => new Date(a.date) - new Date(b.date));
            const lastIndex = sorted.length - 1;
            sorted.forEach((step, idx) => {
                const item = document.createElement('div');
                item.className = `timeline-item ${idx === lastIndex ? 'current' : ''}`;
                item.innerHTML = `
                    <div class="timeline-icon"><i class="${step.icon || 'fas fa-circle'}"></i></div>
                    <div class="timeline-content">
                        <h4>${step.status || ''}</h4>
                        <p>${step.description || ''}</p>
                        <span class="timeline-date">${step.date ? new Date(step.date).toLocaleDateString('en-IN') : ''}</span>
                    </div>
                `;
                timeline.appendChild(item);
            });
        }

        function renderUpdates(updates) {
            const container = document.getElementById('statusUpdates');
            container.innerHTML = '';
            // sort desc by date
            const sorted = [...updates].sort((a, b) => new Date(b.date) - new Date(a.date));
            sorted.forEach(update => {
                const el = document.createElement('div');
                el.className = 'status-update';
                el.innerHTML = `
                    <div class="update-header">
                        <span class="update-date">${update.date ? new Date(update.date).toLocaleDateString('en-IN') : ''}</span>
                        <span class="update-author">${update.author || ''}</span>
                    </div>
                    <p>${update.update || ''}</p>
                `;
                container.appendChild(el);
            });
        }

        function renderRelated(related) {
            const container = document.getElementById('relatedIssues');
            container.innerHTML = '';
            related.forEach(issue => {
                const el = document.createElement('a');
                el.className = 'related-issue';
                el.href = `track-issue.html?id=${encodeURIComponent(issue.id)}`;
                const statusCls = normalizeStatusClass(issue.status || '');
                el.innerHTML = `
                    <div class="issue-info">
                        <h4>${issue.title}</h4>
                        <span class="issue-category">${issue.category}</span>
                        <span class="issue-status ${statusCls}">${issue.status}</span>
                    </div>
                    <div class="issue-distance">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${issue.distance || ''}</span>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        // Upvote handling (prevent multiple upvotes per issue per user using localStorage)
        function hasUpvoted(issueId) {
            const s = localStorage.getItem('upvotedIssues') || '[]';
            try { return JSON.parse(s).includes(issueId); } catch { return false; }
        }
        function setUpvoted(issueId) {
            const s = localStorage.getItem('upvotedIssues') || '[]';
            let arr = [];
            try { arr = JSON.parse(s); } catch {}
            if (!arr.includes(issueId)) {
                arr.push(issueId);
                localStorage.setItem('upvotedIssues', JSON.stringify(arr));
            }
        }

        // Event handlers
        function shareIssue(issue) {
            const url = window.location.href;
            const text = `Check out this civic issue: ${issue.title}`;
            if (navigator.share) {
                navigator.share({ title: issue.title, text, url })
                    .catch(() => {});
            } else {
                navigator.clipboard.writeText(url).then(
                    () => setNotice('Link copied to clipboard.', 'success'),
                    () => setNotice('Could not copy link. Please copy manually.', 'error'),
                );
            }
        }

        function upvoteIssue(issue) {
            if (!isLoggedIn()) {
                setNotice('Please login to upvote issues.', 'error');
                return;
            }
            if (hasUpvoted(issue.id)) {
                setNotice('You already upvoted this issue.', 'error');
                return;
            }
            // Update UI count
            const el = document.getElementById('upvoteCount');
            const current = parseInt(el.textContent || '0', 10) || 0;
            el.textContent = (current + 1).toLocaleString();
            setUpvoted(issue.id);

            // Award points (prefer centralized addUserPoints, else fallback)
            try {
                if (typeof addUserPoints === 'function') addUserPoints(5);
                else {
                    const pts = parseInt(localStorage.getItem('userPoints') || '0', 10) || 0;
                    const newPts = pts + 5;
                    localStorage.setItem('userPoints', String(newPts));
                    const navEl = document.getElementById('navUserPoints');
                    if (navEl) navEl.textContent = newPts.toLocaleString();
                }
            } catch {}

            setNotice('Thank you for upvoting! You earned 5 points.', 'success');
        }

        // Mobile Navigation Toggle (defensive)
        (function initNav() {
            const hamburger = document.querySelector('.hamburger');
            const navMenu = document.querySelector('.nav-menu');
            if (hamburger && navMenu) {
                const toggle = () => {
                    const active = hamburger.classList.toggle('active');
                    navMenu.classList.toggle('active', active);
                    hamburger.setAttribute('aria-expanded', active ? 'true' : 'false');
                };
                hamburger.addEventListener('click', toggle);
                hamburger.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); }
                });
                document.querySelectorAll('.nav-link').forEach(n => n.addEventListener('click', () => {
                    hamburger.classList.remove('active');
                    navMenu.classList.remove('active');
                    hamburger.setAttribute('aria-expanded', 'false');
                }));
            }
        })();

        // Close profile dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const avatar = document.querySelector('.user-avatar');
            if (!dropdown || !avatar) return;
            if (!avatar.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Page init
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof initializePointsDisplay === 'function') initializePointsDisplay();

            const issue = resolveIssue();
            window.currentIssue = issue;
            renderIssue(issue);

            // Wire buttons
            const shareBtn = document.getElementById('shareBtn');
            const upvoteBtn = document.getElementById('upvoteBtn');
            shareBtn?.addEventListener('click', () => shareIssue(issue));
            upvoteBtn?.addEventListener('click', () => upvoteIssue(issue));

            // Show info if opened by deep link
            const id = qs('id');
            if (id) setNotice(`Tracking issue ${id}`, 'success');
        });
    </script>
    
    <!-- Chatbot Integration -->
    <script src="https://cdn.botpress.cloud/webchat/v3.2/inject.js"></script>
    <script src="https://files.botpress.cloud/2025/08/31/14/20250831144221-5HKMW4DF.js" defer=""></script>


<script type="module" src="./js/api.js"></script>

<script type="module" src="./js/auth-bootstrap.js"></script>
</body></html>